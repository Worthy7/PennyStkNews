<!DOCTYPE html>


<html>
<body>

    <div ng-app="myShoppingList" ng-controller="postsController">
        <div id="overview-widget"></div>
        <button ng-click="updateData()">Refresh Data</button>
        <ul>
            <li ng-repeat="post in posts">
                <h3>{{post.ticker}}</h3>
                {{post.pubDate}} <br>
                <a target="_blank" href="{{post.gid}}">{{post.title}}</a><br>
                {{post.price}} <br>
            </li>
        </ul>
    </div>
</body>
</html>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
<script type="text/javascript" src="moment-with-locales.min.js"></script>
<script type="text/javascript" src="moment-timezone-with-data.min.js"></script>
<script type="text/javascript" src="storage.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="site.js"></script>
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<script>
    var app = angular.module("myShoppingList", []);




    app.controller("postsController", ['$scope', '$interval',
        function ($scope, $interval) {


            $scope.updateData = function () {
                console.log("checkingfeed")
                updateFeed(function () {



                    console.log(stg.get("feeddate"))
                    if (stg.get("feeddate") == $scope.lastDate) {
                        console.log("date same, returning")
                        return;
                    }
                    console.log("date different loading data")

                    $scope.lastDate = stg.get("feeddate")
                    this.posts = stg.getPosts().slice(0, 50)
                    postsvms = []
                    for (var i = 0; i < this.posts.length; i++) {
                        post = this.posts[i]

                        postsvms.push({
                            gid: post.guid,
                            pubDate: (new moment(post.pubdate).tz('America/New_York').format("YYYY-MM-DD HH:mm:ss")),
                            title: post.title,
                            price: post.price,
                            ticker: post.ticker
                        })
                    }
                    console.log("Finished fetching from store... loading screen")
                    $scope.posts = postsvms
                    $scope.$apply()

                    widgetTickers = []
                    for (var i = 0; i < this.posts.length; i++) {
                        post = this.posts[i]

                        widgetTickers.push([post.ticker, post.ticker+"|1d"])
                    }

                    new TradingView.MediumWidget({
                        "container_id": "overview-widget",
                        "symbols": widgetTickers,
                        "gridLineColor": "#e9e9ea",
                        "fontColor": "#83888D",
                        "underLineColor": "#dbeffb",
                        "trendLineColor": "#4bafe9",
                        "width": "100%",
                        "height": "500px",
                        "locale": "en"
                    })

                })
            }
            $scope.updateData();
            $interval($scope.updateData, 60 * 1000)
        }]);






</script>
